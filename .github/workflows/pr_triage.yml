name: Collect PR Comments

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

jobs:
  collect:
    if: github.event.issue.pull_request || github.event.pull_request
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Collect Comment
        run: |
          # Skip bot comments
          if [ "${{ github.event.comment.user.type }}" = "Bot" ]; then
            echo "Skipping bot comment"
            exit 0
          fi
          
          PR_NUMBER="${{ github.event.issue.number }}"
          AUTHOR="${{ github.event.comment.user.login }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMENT_ID="${{ github.event.comment.id }}"
          
          # Create pr_comments directory if needed
          mkdir -p dev_ops/pr_comments
          
          # Append to PR-specific comments file
          COMMENTS_FILE="dev_ops/pr_comments/PR-${PR_NUMBER}.md"
          
          # Create file with header if new
          if [ ! -f "$COMMENTS_FILE" ]; then
            cat > "$COMMENTS_FILE" << EOF
          # PR #${PR_NUMBER} Comments
          
          Comments collected for agent triage during PR phase.
          
          ---
          
          EOF
          fi
          
          # Append new comment
          cat >> "$COMMENTS_FILE" << EOF
          
          ## Comment #${COMMENT_ID}
          
          | Field | Value |
          |-------|-------|
          | Author | @${AUTHOR} |
          | Time | ${TIMESTAMP} |
          | Status | pending |
          
          ### Content
          
          ${{ github.event.comment.body }}
          
          ---
          
          EOF
          
          echo "Collected comment #${COMMENT_ID} to ${COMMENTS_FILE}"

      - name: Commit Comments
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dev_ops/pr_comments/
          git diff --staged --quiet && exit 0  # Skip if no changes
          git commit -m "chore: collect PR comment for triage"
          git push
